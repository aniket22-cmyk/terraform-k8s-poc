name: Deploy to EC2 Kubernetes

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        run: terraform init
        working-directory: ./terraform

      - name: Terraform Apply
        run: terraform apply -auto-approve
        working-directory: ./terraform
        env:
          TF_VAR_key_name: ${{ secrets.EC2_KEY_NAME }}

      - name: Get EC2 Public IP
        id: get-ip
        run: |
          cd terraform
          IP=$(terraform output -raw ec2_public_ip)
          if [ -z "$IP" ]; then
            echo "‚ùå FATAL: ec2_public_ip is empty!"
            exit 1
          fi
          echo "‚úÖ EC2 IP: $IP"
          echo "ip=$IP" >> $GITHUB_OUTPUT

      - name: Debug Secrets & Environment
        run: |
          echo "üîç Debug: Checking secrets and env"
          echo "EC2_KEY_NAME = '${{ secrets.EC2_KEY_NAME }}'"
          echo "SSH key length = ${#SSH_PRIVATE_KEY}"
          echo "IP from previous step = '${{ steps.get-ip.outputs.ip }}'"
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Setup SSH Key (Safe)
        run: |
          echo "üîß Setting up SSH..."
          mkdir -p ~/.ssh
          echo "‚úÖ mkdir succeeded"

          # Write key with extra safety
          if [ -z "$SSH_PRIVATE_KEY" ]; then
            echo "‚ùå SSH_PRIVATE_KEY is EMPTY!"
            exit 1
          fi

          # Use printf to avoid echo quirks
          printf '%s' "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          echo "‚úÖ Key written. File size: $(wc -c < ~/.ssh/id_rsa) bytes"

          # Validate it's a real SSH key
          if ! head -n1 ~/.ssh/id_rsa | grep -q "PRIVATE KEY"; then
            echo "‚ùå Key does NOT look like a valid private key!"
            cat ~/.ssh/id_rsa
            exit 1
          fi

          # Wait a bit before ssh-keyscan
          sleep 10
          HOST="${{ steps.get-ip.outputs.ip }}"
          if [ -z "$HOST" ]; then
            echo "‚ùå HOST is empty!"
            exit 1
          fi
          echo "üì° Running ssh-keyscan for $HOST"
          ssh-keyscan "$HOST" >> ~/.ssh/known_hosts
          echo "‚úÖ SSH setup complete"
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Copy App to EC2 (with retry)
        run: |
          set +e
          HOST="${{ steps.get-ip.outputs.ip }}"
          for i in {1..12}; do
            echo "üîÑ Attempt $i to copy app.py to ubuntu@$HOST..."
            scp -o StrictHostKeyChecking=no -o ConnectTimeout=30 -o BatchMode=yes app.py ubuntu@$HOST:/home/ubuntu/app/app.py
            if [ $? -eq 0 ]; then
              echo "‚úÖ Copy succeeded!"
              exit 0
            fi
            echo "‚ö†Ô∏è Attempt $i failed. Waiting 30s before retry..."
            sleep 30
          done
          echo "‚ùå Failed to copy app.py after 12 attempts (6 minutes)"
          exit 1

      - name: Deploy to Kubernetes
        run: |
          HOST="${{ steps.get-ip.outputs.ip }}"
          echo "‚è≥ Waiting for Minikube to be ready (kubeconfig to appear)..."
          # Wait for kubeconfig to exist
          for i in {1..60}; do
            if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 ubuntu@$HOST "test -f /home/ubuntu/.kube/config"; then
              echo "‚úÖ kubeconfig found!"
              break
            fi
            # Show user-data logs for debugging
            if [ $((i % 10)) -eq 0 ]; then
              echo "checking setup progress..."
              ssh -o StrictHostKeyChecking=no ubuntu@$HOST "tail -20 /var/log/user-data.log" || true
            fi

            echo "waiting....(attempt $i/60)"
            sleep 10
          done

          # Double-check: if still missing, fail
          if ! ssh -o StrictHostKeyChecking=no ubuntu@$HOST "test -f /home/ubuntu/.kube/config"; then
            echo "minikube setup failed!"
            ssh -o StrictHostKeyChecking=no ubuntu@$HOST "cat /var/log/user-data.log"
            exit 1
          fi
          # Fetch and deploy
          scp -o StrictHostKeyChecking=no ubuntu@$HOST:/home/ubuntu/.kube/config ~/.kube/config
          kubectl apply -f k8s/deployment.yaml